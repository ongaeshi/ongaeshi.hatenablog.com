RubyPicoのスレッド設計について 〜メインスレッドとmrubyスレッドは主従関係を結ぶ〜

RubyPicoというiOSで動くRuby(正確にはmruby)処理系をここ最近はこつこつ作っています。

これを作ろうと思ったのは[mruby](https://mruby.org/)が誕生して何か作りたい、一番ベタなのはスマホで動くやつだろうという思いつきに他なりません(予想に反してPCで動くのが流行りました)。mrubyはCRubyに比べて組み込みやすく作られているし、iOSは低レイヤーがObjective-Cで書かれているのでC言語で書かれたmrubyと相性がよいと思い選びました。実際、簡単なスクリプト文字列を動かしたり、独自の組み込みメソッドを定義して動かすまでは本当にあっさり動いて感動しました。

ただそこからは少し苦労しました。スマホとプログラミング言語、という新しい組み合わせの仕様について悩む部分が大半だったと記憶しています。今回はその中でも何度も作り直したスレッド設計の部分についてまとめてみます。

## iOSはプロセスが使えない
PCで動く大抵のプログラム言語のインタプリタは、

```
$ foo bar.rb   # bar.rbを実行する新しいプロセスを起動！
.              # プロセスを実行中
.
$              # 終了
```

のように新しいプロセス

## 初期: 処理の途中でyieldする

問題: loop do - end が書けない

## 改良1: mrubyを別スレッドで実行する

問題: 両方向から操作が走って

## 改良2: メインスレッドからmrubyスレッドへの操作を禁止する
